# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

`gocov` is a Go coverage aggregation tool that analyzes test coverage profiles and displays directory-level coverage statistics. It processes standard Go coverage profiles generated by `go test` and provides flexible aggregation and filtering options.

## Development Commands

### Testing
- **Run all tests**: `go test ./...`
- **Run tests with coverage**: `go test -coverprofile=coverage.out -coverpkg=./... ./...`
- **Run specific test**: `go test -run TestName ./...`
- **Run E2E tests**: `go test -tags=e2e ./...`

### Code Quality
- **Format code**: `go fmt ./...`
- **Lint code**: `go vet ./...`
- **Check coverage**: `go test -coverprofile=coverage.out ./... && go tool cover -html=coverage.out`

### Build & Run
- **Build binary**: `go build -o gocov`
- **Install locally**: `go install`
- **Run with test data**: `gocov -coverprofile=testdata/coverage.out`

## Architecture

The codebase follows a modular design with clear separation of concerns:

- **CLI Layer** (`cli.go`): Command-line interface handling, flag parsing, configuration loading, and workflow orchestration
- **Configuration** (`config.go`): YAML configuration file management with hierarchical search from current directory upwards
- **Coverage Analysis**:
  - `analyzer.go`: Core aggregation logic for directory-level coverage
  - `analyzer_concurrent.go`: Parallel processing for large projects (auto-enabled for >10 files)
- **Diff Coverage** (`diff.go`, `diff_coverage.go`): Git integration for analyzing coverage of changed lines only
- **Output Formatting** (`formatter.go`): Table and JSON output formatters with extensible interface design
- **Error Handling** (`errors.go`, `validation.go`): Structured error types for better diagnostics

### Key Design Patterns
- **Worker Pool Pattern**: Concurrent processing with up to 4 workers for large coverage files
- **Interface-based Extensibility**: Formatter interface allows easy addition of new output formats
- **Performance Optimization**: Pre-allocated slices/maps based on profile size estimation
- **Hierarchical Configuration**: Command-line args > specified config > .gocov.yml search > defaults

## Development Workflow

### Before Committing Code
Always run these commands before committing:
1. `go test ./...` - Ensure all tests pass
2. `go test -coverprofile=coverage.out ./...` - Check coverage hasn't decreased significantly
3. `go fmt ./...` - Format code according to Go standards
4. `go vet ./...` - Check for code issues

### When Adding Features
- Update README.md with new feature documentation and examples
- Add comprehensive tests for new functionality
- Ensure new code follows existing patterns and conventions
- Make incremental commits rather than large monolithic changes

### Testing Strategy
- Unit tests for individual components
- Integration tests in `main_e2e_test.go`
- Test data in `testdata/` directory includes edge cases (empty files, invalid formats, zero statements)
- Concurrent processing tests verify performance improvements

## Important Notes

- The project uses `golang.org/x/tools/cover` for standard Go coverage profile parsing
- Diff coverage feature requires git repository context
- Concurrent processing automatically enables for >10 files in coverage profile
- Configuration files (`.gocov.yml`) are searched from current directory upwards to root